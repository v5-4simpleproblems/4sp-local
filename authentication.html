<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - LINK DEVICE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../injector.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-darkest-gray': '#040404',
                        'custom-dark-gray': '#111111',
                        'custom-medium-gray': '#252525',
                        'custom-light-gray': '#505050',
                        'custom-white-gray': '#c0c0c0',
                    }
                }
            }
        }
    </script>
    <style>
        :root { --geist-foreground: 192, 192, 192; --geist-background: 7, 7, 7; }
        body { font-family: 'Geist', sans-serif; background-color: rgb(var(--geist-background)); color: rgb(var(--geist-foreground)); }
        h1, h2, h3 { font-weight: 400 !important; }
    </style>
</head>
<body class="bg-custom-darkest-gray text-custom-white-gray min-h-screen flex flex-col">

    <div id="navbar-container"></div>
    <main class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-custom-dark-gray border border-custom-medium-gray p-8 rounded-2xl shadow-2xl">
            <h2 class="text-3xl text-center mb-6 tracking-tighter text-white">Link Device</h2>
            <p class="text-center text-custom-light-gray mb-8">
                Enter the 12-character connection code from your account dashboard.
            </p>

            <div id="authSection" class="flex flex-col gap-4">
                <button id="generateCodeBtn" class="w-full p-4 bg-white text-black font-medium rounded-xl hover:bg-gray-200 transition">
                    GENERATE CODE
                </button>
                <div id="message" class="mt-4 text-center text-sm min-h-[20px]"></div>
                
                <div id="generatedCodeDisplay" class="hidden mt-6 bg-custom-medium-gray p-4 rounded-xl text-center">
                    <p class="text-custom-light-gray text-sm mb-2">Your one-time unlock code:</p>
                    <div class="relative">
                        <input type="text" id="displayCode" readonly class="w-full p-3 text-center text-2xl font-mono tracking-widest bg-black border border-custom-medium-gray rounded-xl uppercase text-white select-all">
                        <button id="copyCodeBtn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-custom-dark-gray rounded-lg hover:bg-custom-light-gray transition">
                            <i class="fa-regular fa-copy text-custom-white-gray"></i>
                        </button>
                    </div>
                    <p id="codeExpiry" class="text-xs text-custom-light-gray mt-2"></p>
                    <p class="text-sm text-red-400 mt-4 font-bold">
                        IMPORTANT: Copy this code now! It will only be shown once.
                    </p>
                </div>
                
                <!-- Placeholder for existing codes and revoke functionality -->
                <div id="manageCodesSection" class="mt-8 pt-4 border-t border-custom-medium-gray hidden">
                    <h3 class="text-xl text-center mb-4 text-white">Your Active Codes</h3>
                    <div id="activeCodesList" class="flex flex-col gap-3">
                        <!-- Codes will be listed here -->
                        <p class="text-custom-light-gray text-center">No active codes found.</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <a href="#" id="authHelpLink" class="text-custom-light-gray hover:text-white underline text-sm">
                    How does this work?
                </a>
            </div>
        </div>
    </main>

    <script type="module">
        // Ensure Firebase App and Firebase Auth are loaded before this script executes.
        // For example, in your index.html or a common bootstrapper:
        // <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js"></script>
        // <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth.js"></script>
        // <script src="/firebase-config.js"></script>
        // <script>firebase.initializeApp(firebaseConfig);</script>
        // Make sure a user signs in via Google/other providers before reaching this page
        // (or implement sign-in flow directly on this page if not handled elsewhere).
        
        // This script will assume `firebase.auth()` and `firebase.firestore()` are available.
        // If using modular SDK, imports would look like:
        // import { getAuth, onAuthStateChanged } from 'firebase/auth';
        // import { getFirestore, collection, query, where, getDocs } from 'firebase/firestore';

        document.addEventListener('DOMContentLoaded', () => {
            const generateCodeBtn = document.getElementById('generateCodeBtn');
            const messageElement = document.getElementById('message');
            const generatedCodeDisplay = document.getElementById('generatedCodeDisplay');
            const displayCodeInput = document.getElementById('displayCode');
            const copyCodeBtn = document.getElementById('copyCodeBtn');
            const codeExpiryElement = document.getElementById('codeExpiry');
            const manageCodesSection = document.getElementById('manageCodesSection');
            const activeCodesList = document.getElementById('activeCodesList');

            // TODO: Update these endpoints to your deployed Cloud Functions URLs
            const CLOUD_FUNCTIONS_BASE_URL = 'https://your-cloud-functions-url.cloudfunctions.net';
            const GENERATE_CODE_ENDPOINT = `${CLOUD_FUNCTIONS_BASE_URL}/generateCode`; 
            const REVOKE_CODE_ENDPOINT = `${CLOUD_FUNCTIONS_BASE_URL}/revokeCode`; 

            // Function to get Firebase ID token, if authenticated
            async function getAuthToken() {
                try {
                    // Check if Firebase Auth is initialized and a user is signed in
                    if (typeof firebase !== 'undefined' && firebase.auth() && firebase.auth().currentUser) {
                        return await firebase.auth().currentUser.getIdToken();
                    } else {
                        // console.warn('Firebase Auth not initialized or user not signed in.');
                        return null;
                    }
                } catch (error) {
                    console.error('Error getting auth token:', error);
                    return null;
                }
            }

            generateCodeBtn.addEventListener('click', async () => {
                messageElement.textContent = 'Generating code...';
                messageElement.className = 'mt-4 text-center text-sm text-yellow-500';
                generatedCodeDisplay.classList.add('hidden');

                try {
                    const idToken = await getAuthToken();
                    if (!idToken) {
                        messageElement.textContent = 'Please sign in to generate a code.';
                        messageElement.className = 'mt-4 text-center text-sm text-red-500';
                        return;
                    }

                    const response = await fetch(GENERATE_CODE_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}` // Include auth token for function authorization
                        },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to generate code.');
                    }

                    const data = await response.json();
                    if (data.success) {
                        displayCodeInput.value = data.code;
                        codeExpiryElement.textContent = `Expires: ${new Date(data.expiresAt).toLocaleString()}`;
                        messageElement.textContent = '';
                        generatedCodeDisplay.classList.remove('hidden');

                        displayCodeInput.select();
                        displayCodeInput.setSelectionRange(0, 99999);

                        try {
                            await navigator.clipboard.writeText(data.code);
                            messageElement.textContent = 'Code generated and copied to clipboard!';
                            messageElement.className = 'mt-4 text-center text-sm text-green-500';
                        } catch (err) {
                            console.warn('Failed to copy to clipboard automatically:', err);
                            messageElement.textContent = 'Code generated. Please copy it manually.';
                            messageElement.className = 'mt-4 text-center text-sm text-blue-500';
                        }
                        // Refresh the list of active codes
                        await fetchActiveCodes();
                    } else {
                        throw new Error(data.message || 'Unknown error during code generation.');
                    }

                } catch (error) {
                    console.error('Error generating code:', error);
                    messageElement.textContent = `Error: ${error.message}`;
                    messageElement.className = 'mt-4 text-center text-sm text-red-500';
                }
            });

            copyCodeBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(displayCodeInput.value);
                    messageElement.textContent = 'Code copied to clipboard!';
                    messageElement.className = 'mt-4 text-center text-sm text-green-500';
                } catch (err) {
                    console.error('Failed to copy code:', err);
                    messageElement.textContent = 'Failed to copy code. Please select and copy manually.';
                    messageElement.className = 'mt-4 text-center text-sm text-red-500';
                }
            });

            // Function to fetch and display active codes for the current user
            async function fetchActiveCodes() {
                activeCodesList.innerHTML = '<p class="text-custom-light-gray text-center">Loading codes...</p>';
                manageCodesSection.classList.remove('hidden');

                try {
                    const idToken = await getAuthToken();
                    if (!idToken || !firebase.auth().currentUser) {
                        activeCodesList.innerHTML = '<p class="text-custom-light-gray text-center">Please sign in to view your codes.</p>';
                        return;
                    }

                    // Direct Firestore query example (requires security rule: allow read: if request.auth.uid == resource.data.userId; )
                    // This rule would need to be added to `other-required/firestore.rules` for this to work
                    const codesSnapshot = await firebase.firestore().collection('unlockCodes')
                                            .where('userId', '==', firebase.auth().currentUser.uid)
                                            .where('used', '==', false)
                                            .where('revoked', '==', false)
                                            .get();
                    
                    if (codesSnapshot.empty) {
                        activeCodesList.innerHTML = '<p class="text-custom-light-gray text-center">No active codes found.</p>';
                        return;
                    }

                    activeCodesList.innerHTML = ''; // Clear loading message

                    codesSnapshot.forEach(doc => {
                        const codeData = doc.data();
                        const codeHash = doc.id; // The document ID is the code hash
                        const expiration = codeData.expiresAt ? new Date(codeData.expiresAt.toDate()).toLocaleString() : 'Never';
                        const deviceStatus = codeData.deviceFingerprint ? 'Linked' : 'Not linked';

                        const codeItem = document.createElement('div');
                        codeItem.className = 'bg-custom-darkest-gray p-3 rounded-lg flex items-center justify-between';
                        codeItem.innerHTML = `
                            <div>
                                <p class="font-mono text-white text-sm break-all">${codeHash.substring(0, 8)}...</p> <!-- Display partial hash -->
                                <p class="text-xs text-custom-light-gray">Expires: ${expiration} | Device: ${deviceStatus}</p>
                            </div>
                            <button class="revoke-btn bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded-md transition" data-code-hash="${codeHash}">Revoke</button>
                        `;
                        activeCodesList.appendChild(codeItem);
                    });

                    // Add event listeners for revoke buttons
                    document.querySelectorAll('.revoke-btn').forEach(button => {
                        button.addEventListener('click', async (event) => {
                            const hashToRevoke = event.target.dataset.codeHash;
                            messageElement.textContent = `Revoking code ${hashToRevoke.substring(0, 8)}...`;
                            messageElement.className = 'mt-4 text-center text-sm text-yellow-500';

                            try {
                                const idToken = await getAuthToken();
                                if (!idToken) {
                                    messageElement.textContent = 'Please sign in to revoke codes.';
                                    messageElement.className = 'mt-4 text-center text-sm text-red-500';
                                    return;
                                }

                                const response = await fetch(REVOKE_CODE_ENDPOINT, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${idToken}`
                                    },
                                    body: JSON.stringify({ codeHash: hashToRevoke })
                                });

                                if (!response.ok) {
                                    const errorData = await response.json();
                                    throw new Error(errorData.message || 'Failed to revoke code.');
                                }

                                const data = await response.json();
                                if (data.success) {
                                    messageElement.textContent = `Code ${hashToRevoke.substring(0, 8)} revoked successfully!`;
                                    messageElement.className = 'mt-4 text-center text-sm text-green-500';
                                    await fetchActiveCodes(); // Refresh list
                                } else {
                                    throw new Error(data.message || 'Unknown error during revocation.');
                                }

                            } catch (error) {
                                console.error('Error revoking code:', error);
                                messageElement.textContent = `Error: ${error.message}`;
                                messageElement.className = 'mt-4 text-center text-sm text-red-500';
                            }
                        });
                    });

                } catch (error) {
                    console.error('Error fetching active codes:', error);
                    activeCodesList.innerHTML = `<p class="text-red-400 text-center">Error loading codes: ${error.message}. Ensure Firestore rules permit access.</p>`;
                }
            }

            // Initial load of active codes
            // We need to wait for Firebase Auth to be ready.
            if (typeof firebase !== 'undefined' && firebase.auth()) {
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        fetchActiveCodes();
                    } else {
                        activeCodesList.innerHTML = '<p class="text-custom-light-gray text-center">Sign in to manage your codes.</p>';
                        manageCodesSection.classList.remove('hidden');
                    }
                });
            } else {
                activeCodesList.innerHTML = '<p class="text-red-400 text-center">Firebase Auth not available. Cannot manage codes.</p>';
                manageCodesSection.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
