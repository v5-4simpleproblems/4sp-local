<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - LINK DEVICE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../injector.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-darkest-gray': '#040404',
                        'custom-dark-gray': '#111111',
                        'custom-medium-gray': '#252525',
                        'custom-light-gray': '#505050',
                        'custom-white-gray': '#c0c0c0',
                    }
                }
            }
        }
    </script>
    <style>
        :root { --geist-foreground: 192, 192, 192; --geist-background: 7, 7, 7; }
        body { font-family: 'Geist', sans-serif; background-color: rgb(var(--geist-background)); color: rgb(var(--geist-foreground)); }
        h1, h2, h3 { font-weight: 400 !important; }
    </style>
</head>
<body class="bg-custom-darkest-gray text-custom-white-gray min-h-screen flex flex-col">

    <div id="navbar-container"></div>
    <main class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-custom-dark-gray border border-custom-medium-gray p-8 rounded-2xl shadow-2xl">
            <h2 class="text-3xl text-center mb-6 tracking-tighter text-white">Link Device</h2>
            <p class="text-center text-custom-light-gray mb-8">
                Enter the 12-character connection code from your account dashboard.
            </p>

            <form id="linkForm" class="flex flex-col gap-4">
                <div>
                    <input type="text" id="code" placeholder="ENTER-CODE-HERE" maxlength="12" 
                           class="w-full p-4 text-center text-2xl font-mono tracking-widest bg-black border border-custom-medium-gray rounded-xl focus:border-white focus:outline-none uppercase text-white placeholder-custom-medium-gray">
                </div>
                <button type="submit" class="w-full p-4 bg-white text-black font-medium rounded-xl hover:bg-gray-200 transition">
                    CONNECT DEVICE
                </button>
            </form>
            <div id="message" class="mt-4 text-center text-sm min-h-[20px]"></div>
            
            <div class="mt-8 text-center">
                <a href="https://v5-4simpleproblems.github.io/web-files/connection.html" target="_blank" class="text-custom-light-gray hover:text-white underline text-sm">
                    Get a code
                </a>
            </div>
        </div>
    </main>

    <script>
        // Ensure firebase is available globally
        // This script assumes firebase-app-compat.js and firebase-firestore-compat.js are loaded globally
        // by the bootstrapper or other means before this script executes.
        if (typeof firebase === 'undefined' || typeof firebase.firestore === 'undefined') {
            console.error("Firebase or Firestore is not initialized. Please ensure Firebase SDKs are loaded.");
            // Optionally, display an error message to the user
            const msgEl = document.getElementById('message');
            if (msgEl) {
                msgEl.innerText = "Error: Firebase services unavailable.";
                msgEl.className = "mt-4 text-center text-sm text-red-500";
            }
        } else {
            const db = firebase.firestore();

            const form = document.getElementById('linkForm');
            const message = document.getElementById('message');
            const codeInput = document.getElementById('code');

            // Fingerprint Generation
            const getFingerprint = () => {
                let fp = localStorage.getItem('device_fingerprint');
                if (!fp) {
                    fp = 'dev_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
                    localStorage.setItem('device_fingerprint', fp);
                }
                return fp;
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = codeInput.value.trim().toUpperCase();
                if (code.length < 10) { // Basic length check
                    message.innerText = "Invalid code format.";
                    message.className = "mt-4 text-center text-sm text-red-500";
                    return;
                }

                message.innerText = "Verifying...";
                message.className = "mt-4 text-center text-sm text-yellow-500";

                try {
                    const codeRef = db.collection('connection_codes').doc(code);
                    const codeSnap = await codeRef.get(); // Use .get() method on docRef

                    if (!codeSnap.exists) {
                        throw new Error("Invalid code.");
                    }

                    const data = codeSnap.data();
                    if (data.used) {
                        throw new Error("This code has already been used.");
                    }

                    // Link successful
                    const fingerprint = getFingerprint();
                    await codeRef.update({ // Use .update() method on docRef
                        used: true,
                        usedAt: firebase.firestore.FieldValue.serverTimestamp(), // Use compat version
                        fingerprint: fingerprint
                    });

                    // Store session
                    localStorage.setItem('4sp_uid', data.uid);
                    localStorage.setItem('4sp_email', data.email || 'linked-user');
                    
                    message.innerText = "Success! Redirecting...";
                    message.className = "mt-4 text-center text-sm text-green-500";
                    
                    setTimeout(() => {
                        window.localRedirect('logged-in/dashboard.html'); // Use localRedirect
                    }, 1000);

                } catch (err) {
                    console.error(err);
                    message.innerText = err.message;
                    message.className = "mt-4 text-center text-sm text-red-500";
                }
            });
        }
    </script>
</body>
</html>